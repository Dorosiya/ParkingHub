<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.parking_hub.mapper.ParkingRealtimeMapper">

    <resultMap id="ParkingRealtimeResultMap" type="com.example.parking_hub.model.ParkingRealtime">
        <id property="id" column="id"/>
        <result property="parkingId" column="parking_id"/>
        <result property="pkfcParkingLotsTotal" column="pkfc_parking_lots_total"/>
        <result property="pkfcAvailableParkingLotsTotal" column="pkfc_available_parking_lots_total"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="syncDate" column="sync_date"/>
    </resultMap>

    <!-- 주차장 실시간 정보 등록 -->
    <insert id="insertParkingRealtime" parameterType="com.example.parking_hub.model.ParkingRealtime">
        INSERT INTO parking_realtime (
            id, parking_id, pkfc_parking_lots_total, pkfc_available_parking_lots_total,
            updated_at, sync_date
        ) VALUES (
            #{id}, #{parkingId}, #{pkfcParkingLotsTotal}, #{pkfcAvailableParkingLotsTotal},
            #{updatedAt}, NOW()
        )
    </insert>

    <!-- 주차장 실시간 정보 조회 - 전체 -->
    <select id="selectAllParkingRealtimes" resultMap="ParkingRealtimeResultMap">
        SELECT * FROM parking_realtime
    </select>

    <!-- 주차장 실시간 정보 조회 - 특정 ID -->
    <select id="selectParkingRealtimeById" resultMap="ParkingRealtimeResultMap">
        SELECT * FROM parking_realtime WHERE id = #{id}
    </select>

    <!-- 주차장 실시간 정보 수정 -->
    <update id="updateParkingRealtime" parameterType="com.example.parking_hub.model.ParkingRealtime">
        UPDATE parking_realtime
        SET
            pkfc_parking_lots_total = #{pkfcParkingLotsTotal},
            pkfc_available_parking_lots_total = #{pkfcAvailableParkingLotsTotal},
            updated_at = #{updatedAt},
            sync_date = NOW()
        WHERE id = #{id}
    </update>

    <!-- 주차장 실시간 정보 삭제 -->
    <delete id="deleteParkingRealtime">
        DELETE FROM parking_realtime WHERE id = #{id}
    </delete>

    <!-- 주차 가능한 주차장 목록 조회 -->
    <select id="selectAvailableParkingLots" resultMap="ParkingRealtimeResultMap">
        SELECT * FROM parking_realtime
        WHERE pkfc_available_parking_lots_total >= #{minSpots}
        ORDER BY pkfc_available_parking_lots_total DESC
    </select>

    <!-- 주차 공간 이용률이 높은 주차장 목록 조회 -->
    <select id="selectHighOccupancyParkingLots" resultMap="ParkingRealtimeResultMap">
        SELECT *,
            (pkfc_parking_lots_total - pkfc_available_parking_lots_total) / pkfc_parking_lots_total AS occupancy_rate
        FROM parking_realtime
        WHERE pkfc_parking_lots_total > 0
        HAVING occupancy_rate >= #{occupancyRate}
        ORDER BY occupancy_rate DESC
    </select>

    <!-- 주차장 ID 기준으로 실시간 정보 일괄 조회 -->
    <select id="selectParkingRealtimeByIds" resultMap="ParkingRealtimeResultMap">
        SELECT * FROM parking_realtime
        WHERE parking_id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper> 